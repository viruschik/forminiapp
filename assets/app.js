(()=>{
  const tg = window.Telegram?.WebApp; try{tg?.ready();tg?.expand();}catch{}
  const i18n={ru:{lang:'RU',theme:'Тема',welcome:'Добро пожаловать на <span class="brand">Тестмаркет</span>',pick:'Выберите, что хотите сделать',actPremium:'Купить Premium',actBuyStars:'Купить Stars',actSellStars:'Продать Stars',placeholder:'Выберите действие, чтобы продолжить.',toWhom:'Кому купить Premium',self:'Себе',other:'Другому',username:'Username получателя (@username)',months:'Срок подписки',currency:'Валюта оплаты',price:'Цена',howManyBuy:'Сколько Stars купить',howManySell:'Сколько Stars продать',payoutCurrency:'Валюта получения',totalPay:'Итог к оплате',youGet:'Вы получите',faq:'FAQ',supportTitle:'Контакты поддержки',writeSupport:'Написать в поддержку'},en:{lang:'EN',theme:'Theme',welcome:'Welcome to <span class=\"brand\">Testmarket</span>',pick:'Choose what you want to do',actPremium:'Buy Premium',actBuyStars:'Buy Stars',actSellStars:'Sell Stars',placeholder:'Select an action to continue.',toWhom:'Who will get Premium',self:'Myself',other:'Someone else',username:'Recipient username (@username)',months:'Subscription period',currency:'Payment currency',price:'Price',howManyBuy:'How many Stars to buy',howManySell:'How many Stars to sell',payoutCurrency:'Payout currency',totalPay:'Total to pay',youGet:'You will receive',faq:'FAQ',supportTitle:'Support contacts',writeSupport:'Message support'}};
  const state={action:null,theme:localStorage.getItem('tm_theme')||'light',lang:localStorage.getItem('tm_lang')||'ru',form:{}};
  const PRICES={premium:{'3':{TON:15,RUB:1290,USD:3.99,EUR:3.59},'6':{TON:28,RUB:2490,USD:7.49,EUR:6.99},'12':{TON:50,RUB:4590,USD:13.99,EUR:12.99}},starBuyRate:{TON:.00002,RUB:.12,USD:.0025,EUR:.0023},starSellRate:{TON:.000018,RUB:.10}};
  const el={root:document.documentElement,burgerBtn:document.getElementById('burgerBtn'),sidebar:document.getElementById('sidebar'),backdrop:document.getElementById('backdrop'),closeSidebar:document.getElementById('closeSidebar'),langBtn:document.getElementById('langBtn'),langLabel:document.getElementById('langLabel'),langMenu:document.getElementById('langMenu'),themeBtn:document.getElementById('themeBtn'),themeLabel:document.getElementById('themeLabel'),themeMenu:document.getElementById('themeMenu'),welcomeTitle:document.getElementById('welcomeTitle'),pickerLabel:document.getElementById('pickerLabel'),actionPicker:document.getElementById('actionPicker'),actionMenu:document.getElementById('actionMenu'),actPremium:document.getElementById('actPremium'),actBuyStars:document.getElementById('actBuyStars'),actSellStars:document.getElementById('actSellStars'),formArea:document.getElementById('formArea'),formPlaceholder:document.getElementById('formPlaceholder'),faqTitle:document.getElementById('faqTitle'),supportTitle:document.getElementById('supportTitle'),supportBtn:document.getElementById('supportBtn'),supportLink:document.getElementById('supportLink')};
  function applyTheme(t){state.theme=t;localStorage.setItem('tm_theme',t);if(t==='auto'){const d=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;el.root.setAttribute('data-theme',d?'dark':'light');}else el.root.setAttribute('data-theme',t);try{tg?.setHeaderColor?.(t==='dark'?'#0b0f14':'#ffffff');tg?.setBackgroundColor?.(t==='dark'?'#0b0f14':'#ffffff');}catch{}}
  applyTheme(state.theme);
  function applyLang(l){const tx=i18n[l]||i18n.ru;state.lang=l;localStorage.setItem('tm_lang',l);el.langLabel.textContent=tx.lang;el.themeLabel.textContent=(l==='ru'?'Тема':'Theme');el.welcomeTitle.innerHTML=tx.welcome;el.pickerLabel.textContent=tx.pick;el.actPremium.textContent=tx.actPremium;el.actBuyStars.textContent=tx.actBuyStars;el.actSellStars.textContent=tx.actSellStars;el.formPlaceholder.textContent=tx.placeholder;el.faqTitle.textContent=tx.faq;el.supportTitle.textContent=tx.supportTitle;el.supportBtn.textContent=tx.writeSupport;if(state.action) renderForm();}
  applyLang(state.lang);
  function openSidebar(open){if(open){el.sidebar.classList.add('open');el.sidebar.setAttribute('aria-hidden','false');el.backdrop.hidden=false;el.backdrop.setAttribute('aria-open','true');try{tg?.MainButton?.hide();}catch{}}else{el.sidebar.classList.remove('open');el.sidebar.setAttribute('aria-hidden','true');el.backdrop.removeAttribute('aria-open');el.backdrop.hidden=true;updateMainButton();}}
  el.burgerBtn.addEventListener('click',()=>openSidebar(true)); el.backdrop.addEventListener('click',()=>openSidebar(false)); el.closeSidebar.addEventListener('click',()=>openSidebar(false));
  function toggleMenu(menuEl,open){document.querySelectorAll('.menu').forEach(m=>{m.setAttribute('hidden','');m.removeAttribute('aria-open');}); if(open){menuEl.removeAttribute('hidden');menuEl.setAttribute('aria-open','true');}}
  el.langBtn.addEventListener('click',()=>{const isOpen=el.langMenu.hasAttribute('aria-open');toggleMenu(el.langMenu,!isOpen)});
  el.themeBtn.addEventListener('click',()=>{const isOpen=el.themeMenu.hasAttribute('aria-open');toggleMenu(el.themeMenu,!isOpen)});
  document.addEventListener('click',(e)=>{if(!e.target.closest('.control')){document.querySelectorAll('.menu').forEach(m=>{m.setAttribute('hidden','');m.removeAttribute('aria-open');});}});
  el.langMenu.addEventListener('click',(e)=>{const btn=e.target.closest('.menu-item');if(!btn) return;const l=btn.dataset.lang;if(l){el.langMenu.querySelectorAll('.menu-item').forEach(mi=>mi.classList.toggle('active',mi===btn));applyLang(l);toggleMenu(el.langMenu,false);}});
  el.themeMenu.addEventListener('click',(e)=>{const btn=e.target.closest('.menu-item');if(!btn) return;const th=btn.dataset.theme;if(th){applyTheme(th);toggleMenu(el.themeMenu,false);}});
  function togglePicker(){const open=!el.actionMenu.hasAttribute('aria-open');if(open){el.actionMenu.removeAttribute('hidden');el.actionMenu.setAttribute('aria-open','true');}else{el.actionMenu.removeAttribute('aria-open');el.actionMenu.setAttribute('hidden','');}}
  el.actionPicker.addEventListener('click',togglePicker);
  el.actionMenu.addEventListener('click',(e)=>{const it=e.target.closest('.picker-item');if(!it) return;selectAction(it.dataset.action);el.actionMenu.removeAttribute('aria-open');el.actionMenu.setAttribute('hidden','');});
  function selectAction(act){state.action=act;state.form={};renderForm();updateMainButton();}
  function tx(){return i18n[state.lang]||i18n.ru;}
  function renderForm(){const w=el.formArea;w.classList.remove('placeholder');if(state.action==='premium_buy')w.innerHTML=premiumFormHTML(); else if(state.action==='stars_buy')w.innerHTML=starsBuyFormHTML(); else if(state.action==='stars_sell')w.innerHTML=starsSellFormHTML(); else{w.classList.add('placeholder');w.innerHTML=`<p>${tx().placeholder}</p>`;try{tg?.MainButton?.hide();}catch{} return;} attachFormHandlers();}
  function premiumFormHTML(){const t=tx();return `<div class="form-grid"><div class="row cols-2"><div class="radio-group"><label>${t.toWhom}</label><div class="radio-line"><label><input type="radio" name="to" value="self" checked> ${t.self}</label><label><input type="radio" name="to" value="other"> ${t.other}</label></div></div><div class="input"><label for="username">${t.username}</label><input id="username" type="text" placeholder="@username" disabled></div></div><div class="row cols-2"><div class="select"><label for="months">${t.months}</label><select id="months"><option value="" selected disabled>—</option><option value="3">3</option><option value="6">6</option><option value="12">12</option></select></div><div class="select"><label for="currency">${t.currency}</label><select id="currency"><option value="" selected disabled>—</option><option value="TON">TON</option><option value="RUB">RUB</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div></div><div class="card"><div id="priceLine" class="mt-8">${t.price}: —</div></div></div>`;}
  function starsBuyFormHTML(){const t=tx();return `<div class="form-grid"><div class="row cols-2"><div class="input"><label for="starsAmount">${t.howManyBuy}</label><input id="starsAmount" type="number" min="1" step="1" placeholder="500"></div><div class="select"><label for="currency">${t.currency}</label><select id="currency"><option value="" selected disabled>—</option><option value="TON">TON</option><option value="RUB">RUB</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div></div><div class="card"><div id="priceLine" class="mt-8">${t.totalPay}: —</div></div></div>`;}
  function starsSellFormHTML(){const t=tx();return `<div class="form-grid"><div class="row cols-2"><div class="input"><label for="starsAmount">${t.howManySell}</label><input id="starsAmount" type="number" min="1" step="1" placeholder="500"></div><div class="select"><label for="currency">${t.payoutCurrency}</label><select id="currency"><option value="" selected disabled>—</option><option value="TON">TON</option><option value="RUB">RUB</option></select></div></div><div class="card"><div id="priceLine" class="mt-8">${t.youGet}: —</div></div></div>`;}
  function attachFormHandlers(){if(state.action==='premium_buy'){const radios=document.querySelectorAll('input[name="to"]');const username=document.getElementById('username');const months=document.getElementById('months');const currency=document.getElementById('currency');const priceLine=document.getElementById('priceLine');radios.forEach(r=>r.addEventListener('change',()=>{const val=document.querySelector('input[name="to"]:checked').value;state.form.to=val;username.disabled=(val!=='other');updateMainButton();}));username.addEventListener('input',()=>{state.form.username=username.value.trim();updateMainButton();});months.addEventListener('change',()=>{state.form.months=months.value;recalcPrice();});currency.addEventListener('change',()=>{state.form.currency=currency.value;recalcPrice();});function recalcPrice(){const m=state.form.months;const cur=state.form.currency;const t=tx();if(m&&cur&&PRICES.premium[m]?.[cur]!=null){state.form.amount=PRICES.premium[m][cur];priceLine.textContent=`${t.price}: ${state.form.amount} ${cur}`;}else{state.form.amount=null;priceLine.textContent=`${t.price}: —`; } updateMainButton();}} if(state.action==='stars_buy'||state.action==='stars_sell'){const amount=document.getElementById('starsAmount');const currency=document.getElementById('currency');const priceLine=document.getElementById('priceLine');amount.addEventListener('input',()=>{state.form.stars=parseInt(amount.value,10)||0;recalc();});currency.addEventListener('change',()=>{state.form.currency=currency.value;recalc();});function recalc(){const stars=state.form.stars||0;const cur=state.form.currency;const t=tx();if(!stars||!cur){state.form.amount=null;priceLine.textContent=(state.action==='stars_buy')?`${t.totalPay}: —`:`${t.youGet}: —`;updateMainButton();return;}const rate=(state.action==='stars_buy')?PRICES.starBuyRate[cur]:PRICES.starSellRate[cur];if(!rate){state.form.amount=null;priceLine.textContent='—';}else{const total=+(stars*rate).toFixed(6);state.form.amount=total;priceLine.textContent=(state.action==='stars_buy')?`${t.totalPay}: ${total} ${cur}`:`${t.youGet}: ${total} ${cur}`;}updateMainButton();}}}
  function updateMainButton(){let ok=false,label='Оплатить';if(state.action==='premium_buy'){const to=state.form.to||'self';const otherOk=(to==='self')||(to==='other'&&/^@?[a-zA-Z0-9_]{5,}$/.test(state.form.username||''));ok=!!(otherOk&&state.form.months&&state.form.currency&&state.form.amount!=null);if(ok) label=(state.lang==='ru')?`Оплатить ${state.form.amount} ${state.form.currency}`:`Pay ${state.form.amount} ${state.form.currency}`;}
    if(state.action==='stars_buy'||state.action==='stars_sell'){ok=!!(state.form.stars>0&&state.form.currency&&state.form.amount!=null);if(ok) label=(state.action==='stars_buy')?((state.lang==='ru')?`Оплатить ${state.form.amount} ${state.form.currency}`:`Pay ${state.form.amount} ${state.form.currency}`):((state.lang==='ru')?`Получить ${state.form.amount} ${state.form.currency}`:`Receive ${state.form.amount} ${state.form.currency}`);}
    try{if(tg){if(ok && el.sidebar.getAttribute('aria-hidden')!=='false'){tg.MainButton.setText(label);tg.MainButton.show();tg.MainButton.onClick(payNow);}else{tg.MainButton.hide();tg.MainButton.offClick(payNow);}}}catch{}}
  function payNow(){const {action,form}=state;if(!form?.amount) return;const summary={action,...form};if(form.currency==='TON') alert((state.lang==='ru'?'Откроем TON-кошелёк (заглушка).':'Open TON wallet (stub).')+'\n\n'+JSON.stringify(summary,null,2)); else alert((state.lang==='ru'?'Откроем платёжную страницу (заглушка).':'Open payment page (stub).')+'\n\n'+JSON.stringify(summary,null,2));}
  selectAction(null);
  document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){openSidebar(false);document.querySelectorAll('.menu').forEach(m=>{m.setAttribute('hidden','');m.removeAttribute('aria-open');});el.actionMenu.setAttribute('hidden','');el.actionMenu.removeAttribute('aria-open');}});
  try{const url=new URL(window.location.href);const sup=url.searchParams.get('support');if(sup){const username=sup.startsWith('@')?sup:'@'+sup;el.supportLink.textContent=username;el.supportLink.href='https://t.me/'+username.replace('@','');}}catch{}
})();